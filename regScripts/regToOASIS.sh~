#!/bin/bash

function get4DV1() {

    # fslview does not display 5D NIFTI vectors correctly, requires 4D
    
    dt=$1
    output=$2
    
    tmpFileRoot=`basename ${dt%.nii.gz}`
    
    ${ANTSPATH}ImageMath 3 /tmp/${tmpFileRoot}V1.nii.gz TensorToVector $dt 2
    
    for (( i=0; i<3; i++ )); do
        ${ANTSPATH}ImageMath 3 /tmp/${tmpFileRoot}V1${i}.nii.gz ExtractVectorComponent /tmp/${tmpFileRoot}V1.nii.gz $i
    done
    
    ${ANTSPATH}ImageMath 4 ${output} TimeSeriesAssemble 1 0 /tmp/${tmpFileRoot}V10.nii.gz /tmp/${tmpFileRoot}V11.nii.gz /tmp/${tmpFileRoot}V12.nii.gz 
    
}

binDir=`dirname $0`

if [[ $# -eq 0 ]]; then
    echo " 
  $0 <moving series> 

  Run this from the directory above scripts/ . Output is to reg/ .

  Uses ANTs with ANTSPATH=${ANTSPATH}

"
    exit 1

fi

movingSeries=$1

fixedT1="reg/OASIS/T_template0_BrainCerebellum_3mm.nii.gz"

movingFA="nativeDT/ants/${movingSeries}/${movingSeries}_FA.nii.gz"
movingDT="nativeDT/ants/${movingSeries}/${movingSeries}_DT.nii.gz"

if [[ !(-f $fixedT1 && -f $movingFA) ]] ; then
    echo " Missing input images "
    exit 1
fi


outputRoot="reg/${movingSeries}ToOASIS/${movingSeries}ToOASIS_"

scripts/regHelper.sh $movingFA $movingDT $fixedT1 $outputRoot
